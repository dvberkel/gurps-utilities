%!PS-Adobe-1.0

/init {
    72 25.4 div dup scale
    0 setlinecap
    1 setlinewidth
} def

/tan { dup sin exch cos div } def
/rrand { rand 16#7FFFFFFF div } def

/randomMidPoint {
    [/angle /currentY /currentX /oldY /oldX] dup length 9 add dict begin {exch def} forall
	/fraction rrand 2 mul 1 sub def

	/length currentX oldX sub dup mul currentY oldY sub dup mul add sqrt def

	/rx currentX oldX sub length div def
	/ry currentY oldY sub length div def
	
	/dl length 2 div fraction mul angle tan mul def
	/dx dl ry neg mul def
	/dy dl rx mul def
	
	/xs currentX oldX add 2 div dx add def
	/ys currentY oldY add 2 div dy add def

	xs ys
    end
} def 

/performCommands { % [[37 51 /moveto] [34 35 /lineto] ... [/closepath]]
    {
	aload pop cvx exec
    } forall
} def

/fractalizelines {
    [/angle] dup length 8 add dict begin {exch def} forall
	[
	    flattenpath
	    {
		2 copy
		[/startY /startX /oldY /oldX] {exch def} forall
		
		[startX startY /moveto]
	    }
	    {
		[/currentY /currentX] {exch def} forall
		
		[
		    oldX oldY currentX currentY angle randomMidPoint
		    /lineto
		]
		[
		    currentX currentY
		    /lineto
		]
		
		/oldX currentX def
		/oldY currentY def
	    }
	    {
		% Because of flattenpath no curveto segments should be present.
	    }
	    {
		[
		    oldX oldY startX startY angle randomMidPoint
		    /lineto
		]
		[
		    startX startY
		    /lineto
		]
		
		/oldX startX def
		/oldY startY def
	    }
	    pathforall
	]
	newpath
	performCommands
    end
} def


save /cleanslate exch def

    /oldX 55 def
    /oldY 50 def
    /currentX oldX 100 add def
    /currentY oldY 0 add def
    
    init

    oldX oldY moveto
    currentX currentY lineto

    0.5 setgray
    stroke

    7 {rrand pop} repeat

    /angle 45 def
    /fraction rrand 2 mul 1 sub def

    /length currentX oldX sub dup mul currentY oldY sub dup mul add sqrt def

    /rx currentX oldX sub length div def
    /ry currentY oldY sub length div def

    /dl length 2 div fraction mul angle tan mul def
    /dx dl ry neg mul def
    /dy dl rx mul def
    
    /xs currentX oldX add 2 div dx add def
    /ys currentY oldY add 2 div dy add def
    
    oldX oldY moveto
    xs ys lineto
    currentX currentY lineto

    0 setgray
    stroke

    oldX oldY moveto
    currentX currentY lineto

    stroke
    showpage
    
cleanslate restore
